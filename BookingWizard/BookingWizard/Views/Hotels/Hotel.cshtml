@using System.Security.Claims;
@using BookingWizard.ModelsVM.HotelRooms;
@using BookingWizard.ModelsVM.Hotels;
@using Microsoft.Extensions.Localization;
@model HotelVM;

<style>

#map {
			height: 200px;
			width: 200px;
		}

		.controls {
			background-color: #fff;
			border-radius: 2px;
			border: 1px solid transparent;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
			box-sizing: border-box;
			font-family: Roboto;
			font-size: 15px;
			font-weight: 300;
			height: 29px;
			margin-left: 17px;
			margin-top: 10px;
			outline: none;
			padding: 0 11px 0 13px;
			text-overflow: ellipsis;
			width: 400px;
		}

		.controls:focus {
			border-color: #4d90fe;
		}

		.input-group-append {
			position: relative;
		}

		.image-container {
			width: 30px;
			height: 30px;
			overflow: hidden;
		}

		.image-container img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
</style>

@{
	var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
}

<div class="container">
	<form method="post" asp-action="Hotel" asp-controller="Hotels">
		<div class="input-group mb-3" style="max-width: 250px;">
			<select class="form-control" name="NumberOfPeople" required>
			<option>1</option>
			<option>2</option>
			<option>3</option>
			<option>4</option>
			<option>5</option>
		</select>
			<input type="hidden" name="id" value="@Model.Id" />
			<div class="input-group-append">
				<button class="btn btn-outline-secondary" type="submit" id="button-addon2">
					<div class="image-container">
						<img src="~/flags/avatar.png" alt="Search" />
					</div>
				</button>
			</div>
		</div>
	</form>

	<div class="container">
		<div class="row">
			<div class="col-md-6 mb-3">
				@if (TempData["OnePhotoLeft"] != null)
				{
					<span id="alertMessage" style="width: 400px; height: 60px; " class="alert alert-danger">@TempData["OnePhotoLeft"]</span>
				}
				<div id="photoContainer"> 
					<img src="/PhotoHotels/GetPhoto/@Model.Image.Id" class="img-fluid" style="height: 300px;" /> 
				</div>
				<div style="text-align: center;"> 
					<button type="button" id="prevButton" class="btn btn-primary"><i></i>
						</button>
					<button type="button" id="nextButton" class="btn btn-primary"><i></i>
						</button> 
					@if (User.IsInRole("Owner") && currentUserId == Model.IdentityUserId)
					{
						<button type="button" id="deletePhotoButton" class="btn btn-danger">
							</button> 
						<button type="button" id="addButton" class="btn btn-success">
							</button> 
						<input type="file" id="photoInput" style="display: none;" accept="image/*" multiple>
					} 
				</div>

			</div>
			<div class="col-md-6">
				<div class="text-center">
					<h1 class="display-4">@Model.HotelName</h1>
					<div class="lead">@Model.HotelLongDescription</div>
					<p class="lead">@Model.Address.AddressName</p>
				</div>
			</div>
		</div>
	</div>

	<div id="map" data-map="@Model.Address.AddressName" style="height: 400px; width: 100%;"></div>

	<div class="row m-4">
		@if (Model.roomList != null)
		{ @foreach (var room in Model.roomList)
			{
				<div class="col-md-4 mb-4">
					<div class="card" style="max-height: 700px;">
						<a href="@Url.Action("Room","Rooms", new { id = room.Id })">
							<img src="/PhotoRooms/GetPhoto/@room.Image.Id" class="img-fluid" style="height: 300px;" />
						</a>
						<h4 class="text-center m-3">@room.Name</h4>
						<hr>
						<p class="text-center">@Localizer["Price"]: @room.roomPricePerNight.ToString("c")</p>
						<p class="text-center">@room.NumberOfPeople @Localizer["People"]</p>
						@if (User.IsInRole("Owner") && currentUserId == Model.IdentityUserId)
						{
							<a href="@Url.Action("Edit","Rooms", new { id = room.Id })" class="btn btn-primary m-3">@Localizer["EditHotel"]</a>
						}
					</div>
				</div>
			} 
		}
	</div> 

	@if (User.IsInRole("Owner") && currentUserId == Model.IdentityUserId)
	{
		@if (TempData["ErrorAddRoom"] != null)
		{
			var serializedString = TempData["ErrorAddRoom"] as string;
			var localizedString = new LocalizedString("ErrorAddRoom", serializedString);
			<span id="alertMessage" style="width: 400px; height: 60px; " class="alert alert-danger">@localizedString</span>
		}
		<div class="mb-3 mt-3"> <button class="btn btn-primary" type="button" id="toggleButton">@Localizer["AddRoom"]</button> </div>
		<div id="myContent" style="display: none;">
			<div>
				@{
					var room = new HotelRoomVM();
					room.HotelId = Model.Id;
				}
				@await Html.PartialAsync("_AddRoomPartial",room)
			</div>
		</div>
		<form method="post" action="/Hotels/Delete">
			<input type="hidden" asp-for="Id" />
			<div class="mb-3"> <button class="btn btn-danger" type="submit" id="deleteButton">@Localizer["DeleteHotel"]</button> </div>
		</form>
	}

	@foreach(var review in Model.AllReviews)
	{
		<div class="card m-2">
				<div class="card-body">
					<h5 class="card-title">Отзыв пользователя: @review.User.UserName</h5>
					<div id="review">
					<p class="card-text">@review.Text</p>

					<p>
						<span class="font-weight-bold">Рейтинг:</span>
						@for (int i = 1; i <= review.Rating; i++)
						{
							<span>&#9733;</span>
						}
					</p>

					<p>
						<span class="font-weight-bold">Дата:</span>
						@review.ReviewDate
					</p>
					@if (currentUserId == review.IdentityUserId)
					{
						<button type="button" id="editReviewBtn"class="btn btn-primary edit-review-btn" data-id="@review.Id" data-date="@review.ReviewDate" data-text="@review.Text" data-ratinf="@review.Rating">Edit
						</button>
					}
					@if (currentUserId == review.IdentityUserId || User.IsInRole("Owner") && currentUserId == Model.IdentityUserId) {
						<form asp-action="DeleteReview" asp-controller="Reviews" method="post">
							<input type="hidden" name="reviewId" value="@review.Id">
							<input type="hidden" name="hotelId" value="@Model.Id">
							<button type="submit" id="deleteButton" class="btn btn-danger">Delete</button>
						</form>
					}
				</div>
				</div>
			</div>
	}
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

@{
	var sureDeleteLocalize = Localizer["SureDelete"];
}

<script>
	var photos = @Html.Raw(Json.Serialize(Model.Images));
	var sureDelete = @Html.Raw(Json.Serialize(sureDeleteLocalize.Value));
	var model = @Html.Raw(Json.Serialize(Model));	
	var modelId = @Html.Raw(Json.Serialize(Model.Id));
	var IdentityUserId = @Html.Raw(Json.Serialize(currentUserId));
</script>

@if (currentUserId != Model.IdentityUserId && User.Identity.IsAuthenticated)
{
	<form method="post" id="addReviewForm" asp-action="AddReview" asp-controller="Reviews">
		@{
			Model.ReviewVM.HotelId = Model.Id;
			Model.ReviewVM.IdentityUserId = currentUserId;
		}
		<input type="hidden" asp-for="ReviewVM.HotelId" />
		<input type="hidden" asp-for="ReviewVM.IdentityUserId" />
		<input type="hidden" asp-for="ReviewVM.User" />

		<div class="form-group">
			<label for="text">@Localizer["TextReview"]</label>
			<textarea asp-for="ReviewVM.Text" class="form-control" id="text" rows="5"></textarea>
			<span asp-validation-for="ReviewVM.Text" style="color: red;" class="text-danger"></span>
		</div>

		<div class="form-group">
			<label for="rating">@Localizer["Rating15Review"]</label>
			<select class="form-control" asp-for="ReviewVM.Rating" id="rating" required>
				<option>1</option>
				<option>2</option>
				<option>3</option>
				<option>4</option>
				<option>5</option>
			</select>
		</div>


		<button type="submit" class="btn btn-primary">@Localizer["SendReview"]</button>

	</form>
}

<script src="~/Scripts/PhotoHotels.js?v="></script>

